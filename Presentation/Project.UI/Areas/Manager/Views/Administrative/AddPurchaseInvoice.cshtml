@model PurchaseInvoiceEditVm

@{
    ViewData["Title"] = "Alım Faturası Ekle";
}

<style>
    
    .standard-form .form-control,
    .standard-form .form-select {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
    }

    
    #detailsTable input, #detailsTable select {
        min-width: 80px;
    }
</style>


<div class="container mt-4" style="max-width: 1000px;">
    <div class="mb-4 text-center">
        <h2>Alım Faturası Ekle</h2>
    </div>

    <form asp-action="AddPurchaseInvoice" method="post" id="invoiceForm" class="card shadow-sm p-4 standard-form">
        @Html.AntiForgeryToken()

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Tedarikçi</label>
                <select asp-for="SupplierId" asp-items="Model.SupplierList" class="form-select"></select>
                <span asp-validation-for="SupplierId" class="text-danger"></span>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Tarih</label>
                <input asp-for="OrderDate" type="date" class="form-control" />
                <span asp-validation-for="OrderDate" class="text-danger"></span>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Toplam Tutar</label>
                <input asp-for="TotalPrice" type="number" step="0.01" class="form-control bg-light fw-bold text-primary" readonly />
            </div>
        </div>

        <div class="mt-4 mb-2 d-flex justify-content-between align-items-center border-bottom pb-2">
            <h5 class="mb-0 text-secondary">Fatura Kalemleri</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" id="addRow">
                <i class="bi bi-plus-circle"></i> + Satır Ekle
            </button>
        </div>

        <div class="table-responsive mb-3">
            <table class="table table-hover table-bordered align-middle" id="detailsTable">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%;">Ürün</th>
                        <th style="width: 20%;">Miktar</th>
                        <th style="width: 25%;">Birim Fiyat</th>
                        <th style="width: 15%;" class="text-center">İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Details.Count; i++)
                    {
                        <tr>
                            <td>
                                <select asp-for="Details[@i].ProductId" asp-items="Model.ProductList" class="form-select form-select-sm"></select>
                            </td>
                            <td>
                                <input asp-for="Details[@i].Quantity" type="number" class="form-control form-control-sm detail-qty" min="1" />
                            </td>
                            <td>
                                <input asp-for="Details[@i].UnitPrice" type="number" step="0.01" class="form-control form-control-sm detail-price" />
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-row">Sil</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end gap-2 border-top pt-3 mt-3">
            <button type="submit" class="btn btn-success px-4">Kaydet</button>
            <a asp-action="PurchaseInvoiceList" class="btn btn-outline-secondary">İptal</a>
            <a asp-action="PurchaseInvoiceList" class="btn btn-secondary px-3">Geri</a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        function recalculateTotal() {
            let total = 0;
            $('#detailsTable tbody tr').each(function () {
                let qty = parseFloat($(this).find('.detail-qty').val()) || 0;
                let price = parseFloat($(this).find('.detail-price').val()) || 0;
                total += qty * price;
            });
            $('#TotalPrice').val(total.toFixed(2));
        }

        $(document).on('input', '.detail-qty, .detail-price', recalculateTotal);

        $('#addRow').click(function () {
            let rowCount = $('#detailsTable tbody tr').length;
            let newRow = `<tr>
                <td>
                    <select name="Details[${rowCount}].ProductId" class="form-select form-select-sm">
                        @foreach (SelectListItem? item in Model.ProductList)
                        {
                                <option value="@item.Value">@item.Text</option>
                        }
                    </select>
                </td>
                <td>
                    <input name="Details[${rowCount}].Quantity" type="number" class="form-control form-control-sm detail-qty" min="1" value="1" />
                </td>
                <td>
                    <input name="Details[${rowCount}].UnitPrice" type="number" step="0.01" class="form-control form-control-sm detail-price" value="0" />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-row">Sil</button>
                </td>
            </tr>`;
            $('#detailsTable tbody').append(newRow);
        });

        $(document).on('click', '.remove-row', function () {
            $(this).closest('tr').remove();
            recalculateTotal();
        });

        $(function () {
            recalculateTotal();
        });
    </script>
}